### Habilitar ARCHIVE LOG do banco de dados

##### Entrar sysdba origem
```sql
export ORACLE_SID=<your_sid>;
sqlplus / as sysdba;
```

### Verificar se o LOG_MODE 
```sql
SELECT LOG_MODE FROM V$DATABASE;
```
Se o banco não estiver em LOG_MODE retornara **NOARCHIVELOG**

### Comandos para habilitar ARCHIVELOG
```sql
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;
SELECT LOG_MODE FROM V$DATABASE; --devera retornar ARCHIVELOG
```


#### Criar uma tabela de teste (dentro do owner que vai ter a tabela observada)
```sql
CREATE USER C##USERSOURCE IDENTIFIED BY C##USERSOURCE;
GRANT DBA TO C##USERSOURCE;
```

#### Conectar com o novo usuário e criar tabela de teste
```sql

CREATE TABLE C##USERSOURCE.tab_teste_1 (
	event_id NUMBER(10),
	descricao VARCHAR2(100),
	date DATE
);
ALTER TABLE C##USERSOURCE.tab_teste_1 ADD CONSTRAINT C##USERSOURCE.tab_teste_1_pk primary key(event_id);

DECLARE
   y NUMBER;
   dt DATE := SYSDATE;
   vCount Number := 1000;
BEGIN
   DBMS_OUTPUT.put_line('Start Inserting ' || vCount || ' lines...');
   FOR x IN 1..vCount
   LOOP
      INSERT INTO tab_teste_1 VALUES(x,'TESTE ' || x || ' - '  || TO_CHAR(sysdate,'hh24miss'), SYSDATE - x);      
      
   END LOOP;
   COMMIT;
   DBMS_OUTPUT.put_line('Finish Inserting ' || vCount || ' lines...');
END;

```

#### conectar a uma conta sysdba para criar role

```sql
GRANT CREATE SESSION TO C##CDC_PRIVS;
GRANT EXECUTE ON SYS.DBMS_LOGMNR TO C##CDC_PRIVS;
GRANT LOGMINING TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO C##CDC_PRIVS;
GRANT SELECT ON V_$DATABASE TO C##CDC_PRIVS;
GRANT SELECT ON V_$THREAD TO C##CDC_PRIVS;
GRANT SELECT ON V_$PARAMETER TO C##CDC_PRIVS;
GRANT SELECT ON V_$NLS_PARAMETERS TO C##CDC_PRIVS;
GRANT SELECT ON V_$TIMEZONE_NAMES TO C##CDC_PRIVS;
GRANT SELECT ON ALL_INDEXES TO C##CDC_PRIVS;
GRANT SELECT ON ALL_OBJECTS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_USERS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_CATALOG TO C##CDC_PRIVS;
GRANT SELECT ON ALL_CONSTRAINTS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_CONS_COLUMNS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_TAB_COLS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_IND_COLUMNS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_ENCRYPTED_COLUMNS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_LOG_GROUPS TO C##CDC_PRIVS;
GRANT SELECT ON ALL_TAB_PARTITIONS TO C##CDC_PRIVS;
GRANT SELECT ON SYS.DBA_REGISTRY TO C##CDC_PRIVS;
GRANT SELECT ON SYS.OBJ$ TO C##CDC_PRIVS;
GRANT SELECT ON DBA_TABLESPACES TO C##CDC_PRIVS;
GRANT SELECT ON DBA_OBJECTS TO C##CDC_PRIVS;
GRANT SELECT ON SYS.ENC$ TO C##CDC_PRIVS;

GRANT SELECT_CATALOG_ROLE TO C##CDC_PRIVS;
GRANT EXECUTE_CATALOG_ROLE TO C##CDC_PRIVS;

-- The following privileges are required additionally for 19c compared to 12c.
GRANT SELECT ON V_$ARCHIVED_LOG TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOG TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGFILE TO C##CDC_PRIVS;
GRANT SELECT ON V_$INSTANCE to C##CDC_PRIVS;

-- Debezium
GRANT SELECT ON V_$LOG TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOG_HISTORY TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGMNR_LOGS TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGMNR_PARAMETERS TO C##CDC_PRIVS;
GRANT SELECT ON V_$LOGFILE TO C##CDC_PRIVS;
GRANT SELECT ON V_$ARCHIVED_LOG TO C##CDC_PRIVS;
GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO C##CDC_PRIVS;
GRANT SELECT ON V_$TRANSACTION TO C##CDC_PRIVS;

GRANT SELECT ON V_$MYSTAT TO C##CDC_PRIVS;
GRANT SELECT ON V_$STATNAME TO C##CDC_PRIVS;
GRANT CREATE TABLE TO  C##CDC_PRIVS;

```

#### Criando usuario que sera utilizado pelo conector CDC:
```sql
CREATE USER C##USERCDC IDENTIFIED BY C##USERCDC DEFAULT TABLESPACE USERS;
ALTER USER C##USERCDC QUOTA UNLIMITED ON USERS;
GRANT C##CDC_PRIVS to C##USERCDC;
```

#### Adicionando Supplemental logging (redo-log)
```sql
ALTER DATABASE ADD SUPPLEMENTAL LOG DATA;
ALTER TABLE C##USERSOURCE.tab_teste_1 ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
```

#### É necessario o usuário CDC ser capaz de fazer SNAPSHOT da tabela:
```sql
GRANT FLASHBACK ON C##USERSOURCE.tab_teste_1 TO C##CDC_PRIVS;
GRANT SELECT ON C##USERSOURCE.tab_teste_1 TO C##CDC_PRIVS;
```

### Setup necessário para todas as tabelas que serão monitratadas:
```sql
GRANT SELECT ON C##USERSOURCE.tab_teste_1 TO C##CDC_PRIVS;
GRANT FLASHBACK ON C##USERSOURCE.tab_teste_1 TO C##CDC_PRIVS;
ALTER TABLE C##USERSOURCE.tab_teste_1 ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
```

#### Verificando procedimentos
```sql
SELECT GRANTEE, OWNER, TABLE_NAME 
FROM DBA_TAB_PRIVS 
WHERE GRANTEE IN (SELECT granted_role 
FROM DBA_ROLE_PRIVS 
WHERE GRANTEE = 'C##USERCDC') 
AND (TABLE_NAME='DBMS_LOGMNR' OR TABLE_NAME='V_$LOGMNR_CONTENTS');
```
```output
GRANTEE OWNER TABLE_NAME
-------------------------------------------
C##CDC_PRIVS SYS DBMS_LOGMNR
C##CDC_PRIVS SYS V_$LOGMNR_CONTENTS
```

#### Agora conecte-se ao C##CDCUSER:
```sql
SELECT * FROM SESSION_PRIVS;
SELECT LOG_MODE FROM V$DATABASE;
SELECT COUNT(*) FROM V$DATABASE;
SELECT COUNT(*) FROM V$THREAD;
SELECT COUNT(*) FROM V$PARAMETER;
SELECT COUNT(*) FROM V$NLS_PARAMETERS;
SELECT COUNT(*) FROM V$TIMEZONE_NAMES;
SELECT COUNT(*) FROM ALL_INDEXES;
SELECT COUNT(*) FROM ALL_OBJECTS;
SELECT COUNT(*) FROM ALL_USERS;
SELECT COUNT(*) FROM ALL_CATALOG;
SELECT COUNT(*) FROM ALL_CONSTRAINTS;
SELECT COUNT(*) FROM ALL_CONS_COLUMNS;
SELECT COUNT(*) FROM ALL_TAB_COLS;
SELECT COUNT(*) FROM ALL_IND_COLUMNS;
SELECT COUNT(*) FROM ALL_ENCRYPTED_COLUMNS;
SELECT COUNT(*) FROM ALL_LOG_GROUPS;
SELECT COUNT(*) FROM ALL_TAB_PARTITIONS;
SELECT COUNT(*) FROM SYS.DBA_REGISTRY;
SELECT COUNT(*) FROM SYS.OBJ$;
SELECT COUNT(*) FROM DBA_TABLESPACES;
SELECT COUNT(*) FROM DBA_OBJECTS;
SELECT COUNT(*) FROM SYS.ENC$;
SELECT COUNT(*) FROM "C##USERSOURCE".TAB_TESTE_1;
-- Flashback query privilege
SELECT COUNT(*) FROM "C##USERSOURCE".TAB_TESTE_1 AS OF TIMESTAMP SYSDATE;

-- Added for 19C
SELECT count(*) FROM V$ARCHIVED_LOG;
SELECT count(*) FROM V$LOG;
SELECT count(*) FROM V$LOGFILE;
SELECT count(*) FROM V$INSTANCE;
SELECT SEQUENCE# FROM V$LOG WHERE STATUS = 'CURRENT';

--YES, NO, NO
SELECT
	SUPPLEMENTAL_LOG_DATA_MIN,
	SUPPLEMENTAL_LOG_DATA_PK,
	SUPPLEMENTAL_LOG_DATA_ALL FROM V$DATABASE;

--TABELAS COM LOG
SELECT * FROM ALL_LOG_GROUPS
WHERE LOG_GROUP_TYPE='ALL COLUMN LOGGING' 
and OWNER='C##USERSOURCE';
```


### Referencias:
https://docs.confluent.io/kafka-connectors/oracle-cdc/current/prereqs-validation.html
https://www.profissionaloracle.com.br/2022/11/11/replicando-dados-com-kafka-e-oracle-cdc-parte-iv-preparando-o-banco-de-dados/